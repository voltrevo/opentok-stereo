<!DOCTYPE html>
<html>
<head>
<title>OpenTok Stereo Set-up</title>
</head>
<body>

<h1>OpenTok Stereo Set-up</h1>

<ol>
  <li>
    Add this link as a bookmarklet
    <a href='javascript:(()%3D>%7B(function e(t,n,r)%7Bfunction s(o,u)%7Bif(!n%5Bo%5D)%7Bif(!t%5Bo%5D)%7Bvar a%3Dtypeof require%3D%3D"function"%26%26require%3Bif(!u%26%26a)return a(o,!0)%3Bif(i)return i(o,!0)%3Bvar f%3Dnew Error("Cannot find module %27"%2Bo%2B"%27")%3Bthrow f.code%3D"MODULE_NOT_FOUND",f%7Dvar l%3Dn%5Bo%5D%3D%7Bexports:%7B%7D%7D%3Bt%5Bo%5D%5B0%5D.call(l.exports,function(e)%7Bvar n%3Dt%5Bo%5D%5B1%5D%5Be%5D%3Breturn s(n%3Fn:e)%7D,l,l.exports,e,t,n,r)%7Dreturn n%5Bo%5D.exports%7Dvar i%3Dtypeof require%3D%3D"function"%26%26require%3Bfor(var o%3D0%3Bo<r.length%3Bo%2B%2B)s(r%5Bo%5D)%3Breturn s%7D)(%7B1:%5Bfunction(require,module,exports)%7B%0A%27use strict%27%3B%0A%0Amodule.exports %3D function PositionalAudioPlayer(stream, leftRightBalance %3D 0.5) %7B%0A  const player %3D %7B%7D%3B%0A%0A  const audioCtx %3D new AudioContext()%3B%0A  const source %3D audioCtx.createMediaStreamSource(stream)%3B%0A%0A  const splitter %3D audioCtx.createChannelSplitter(2)%3B%0A  const merger %3D audioCtx.createChannelMerger(2)%3B%0A%0A  source.connect(splitter)%3B%0A%0A  const leftGainNode %3D audioCtx.createGain()%3B%0A  const rightGainNode %3D audioCtx.createGain()%3B%0A%0A  player.setLeftRightBalance %3D (balance) %3D> %7B%0A    leftGainNode.gain.value %3D Math.cos(0.5 * Math.PI * balance)%3B%0A    rightGainNode.gain.value %3D Math.sin(0.5 * Math.PI * balance)%3B%0A  %7D%3B%0A%0A  player.setLeftRightBalance(leftRightBalance)%3B%0A%0A  splitter.connect(leftGainNode, 0)%3B%0A  splitter.connect(rightGainNode, 1)%3B%0A%0A  leftGainNode.connect(merger, 0, 0)%3B%0A  rightGainNode.connect(merger, 0, 1)%3B%0A%0A  merger.connect(audioCtx.destination)%3B%0A%0A  return player%3B%0A%7D%3B%0A%0A%7D,%7B%7D%5D,2:%5Bfunction(require,module,exports)%7B%0A%27use strict%27%3B%0A%0Aconst %7B SessionGroup %7D %3D require(%27./index%27)%3B%0A%0Aconst msg %3D (str) %3D> %7B%0A  const div %3D document.createElement(%27div%27)%3B%0A  div.style.borderRadius %3D %275px%27%3B%0A  div.style.backgroundColor %3D %27%23cff%27%3B%0A  div.style.color %3D %27%23000%27%3B%0A  div.style.zIndex %3D %27100%27%3B%0A  div.textContent %3D str%3B%0A%0A  div.style.position %3D %27fixed%27%3B%0A  div.style.right %3D %2710px%27%3B%0A  div.style.bottom %3D %2710px%27%3B%0A%0A  div.style.padding %3D %2710px%27%3B%0A%0A  document.body.appendChild(div)%3B%0A%0A  let timerId%3B%0A%0A  const clearTimer %3D () %3D> clearTimeout(timerId)%3B%0A%0A  const setTimer %3D () %3D> %7B%0A    timerId %3D setTimeout(() %3D> %7B%0A      div.remove()%3B%0A    %7D, 3000)%3B%0A  %7D%3B%0A%0A  setTimer()%3B%0A%0A  div.addEventListener(%27mouseover%27, () %3D> %7B%0A    clearTimer()%3B%0A    div.style.backgroundColor %3D %27%23cfc%27%3B%0A  %7D)%3B%0A%0A  div.addEventListener(%27mouseout%27, () %3D> %7B%0A    setTimer()%3B%0A    div.style.backgroundColor %3D %27%23cff%27%3B%0A  %7D)%3B%0A%7D%3B%0A%0Aconst run %3D () %3D> %7B%0A  const OT %3D window.OT%3B%0A%0A  if (!window.OT) %7B%0A    msg(%27OpenTok not found on this page.%27)%3B%0A    return%3B%0A  %7D%0A%0A  if (window.opentokStereoActivated) %7B%0A    msg(%27OpenTok Stereo should already be active.%27)%3B%0A    return%3B%0A  %7D%0A%0A  const session %3D OT.sessions.find()%3B%0A%0A  if (!session) %7B%0A    msg(%27Session not found.%27)%3B%0A  %7D%0A%0A  window.opentokStereoSessionGroup %3D SessionGroup(session)%3B%0A%0A  window.opentokStereoActivated %3D true%3B%0A%0A  msg(%27OpenTok Stereo activated.%27)%3B%0A%7D%3B%0A%0Atry %7B%0A  run()%3B%0A%7D catch (e) %7B%0A  msg(%60Exception thrown on set-up: %24%7Be.msg%7D%60)%3B%0A  window.opentokStereoErrors %3D window.opentokStereoErrors %7C%7C %5B%5D%3B%0A  window.opentokStereoErrors.push(e)%3B%0A  throw e%3B%0A%7D%0A%0A%7D,%7B"./index":3%7D%5D,3:%5Bfunction(require,module,exports)%7B%0A%27use strict%27%3B%0A%0A/* eslint-disable no-restricted-syntax */%0A%0Aconst PositionalAudioPlayer %3D require(%27./PositionalAudioPlayer%27)%3B%0A%0Aconst range %3D n %3D> (new Array(n)).fill(0).map((x, i) %3D> i)%3B%0A%0Afunction SubscriberAudioPlayer(subscriber) %7B%0A  subscriber.setAudioVolume(0)%3B%0A%0A  const vid %3D subscriber.element.querySelector(%27video%27)%3B%0A  const stream %3D vid.srcObject%3B%0A%0A  const player %3D %7B%7D%3B%0A%0A  player.setLeftRightBalance %3D PositionalAudioPlayer(stream).setLeftRightBalance%3B%0A%0A  player.getDomBasedBalance %3D () %3D> %7B%0A    const rect %3D vid.getBoundingClientRect()%3B%0A    return (0.5 * (rect.left %2B rect.right)) / window.innerWidth%3B%0A  %7D%3B%0A%0A  return player%3B%0A%7D%0A%0Afunction SubscriberGroup() %7B%0A  const group %3D %7B%7D%3B%0A%0A  const subscribers %3D %5B%5D%3B%0A  const playerMap %3D new WeakMap()%3B%0A%0A  group.add %3D (subscriber) %3D> %7B%0A    const index %3D subscribers.indexOf(subscriber)%3B%0A%0A    if (index !%3D%3D -1) %7B%0A      return%3B%0A    %7D%0A%0A    if (!(subscriber.element %26%26 subscriber.element.querySelector(%27video%27))) %7B%0A      subscriber.on(%27videoElementCreated%27, () %3D> group.add(subscriber))%3B%0A      return%3B%0A    %7D%0A%0A    subscribers.push(subscriber)%3B%0A    playerMap.set(subscriber, SubscriberAudioPlayer(subscriber))%3B%0A    subscriber.on(%27destroyed%27, () %3D> group.remove(subscriber))%3B%0A    group.update()%3B%0A  %7D%3B%0A%0A  group.remove %3D (subscriber) %3D> %7B%0A    const index %3D subscribers.indexOf(subscriber)%3B%0A%0A    if (index %3D%3D%3D -1) %7B%0A      return%3B%0A    %7D%0A%0A    subscribers.splice(index, 1)%3B%0A    group.update()%3B%0A  %7D%3B%0A%0A  group.update %3D () %3D> %7B%0A    if (subscribers.length %3D%3D%3D 1) %7B%0A      playerMap.get(subscribers%5B0%5D).setLeftRightBalance(0.5)%3B%0A    %7D else if (subscribers.length %3D%3D%3D 0) %7B%0A      return%3B%0A    %7D%0A%0A    const rawBalances %3D subscribers.map(sub %3D> playerMap.get(sub).getDomBasedBalance())%3B%0A    const least %3D rawBalances.reduce((x, y) %3D> Math.min(x, y))%3B%0A    const most %3D rawBalances.reduce((x, y) %3D> Math.max(x, y))%3B%0A%0A    if (least %3D%3D%3D most) %7B%0A      for (const sub of subscribers) %7B%0A        playerMap.get(sub).setLeftRightBalance(0.5)%3B%0A      %7D%0A%0A      return%3B%0A    %7D%0A%0A    const balances %3D rawBalances.map(bal %3D> (bal - least) / (most - least))%3B%0A%0A    for (const i of range(balances.length)) %7B%0A      playerMap.get(subscribers%5Bi%5D).setLeftRightBalance(balances%5Bi%5D)%3B%0A    %7D%0A  %7D%3B%0A%0A  group.watch %3D (period %3D 100) %3D> %7B%0A    setInterval(group.update, period)%3B%0A  %7D%3B%0A%0A  return group%3B%0A%7D%0A%0Afunction SessionGroup(session, watchPeriod %3D 100) %7B%0A  const group %3D SubscriberGroup()%3B%0A%0A  const update %3D () %3D> %7B%0A    for (const stream of session.streams.where()) %7B%0A      for (const sub of session.getSubscribersForStream(stream)) %7B%0A        group.add(sub)%3B%0A      %7D%0A    %7D%0A%0A    group.update()%3B%0A  %7D%3B%0A%0A  update()%3B%0A%0A  setInterval(update, watchPeriod)%3B%0A%0A  return group%3B%0A%7D%0A%0Amodule.exports %3D %7B%0A  SubscriberAudioPlayer,%0A  SubscriberGroup,%0A  SessionGroup,%0A%7D%3B%0A%0A%7D,%7B"./PositionalAudioPlayer":1%7D%5D%7D,%7B%7D,%5B2%5D)%3B%7D)()'>drag me into your bookmarks toolbar/folder</a>
  </li>
  <li>Click the bookmarklet on a page with an OpenTok session.</li>
  <li>The message 'OpenTok Stereo activated.' will display, and you will hear subscribers coming from different directions based on their relative positions in the page (you need at least two subscribers).</li>
</ol>

</body>
</html>
